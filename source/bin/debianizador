#!/bin/bash


# debianizador 
# Version: 1.4
# Author: monon



SRC="/source"
EXIT=""
control_file="./debian/control"


function check_user()
{
    echo -e "User: ${USER}"
    if [[ ${UID} = "0" ]] ; then 
        echo -e "Warning!!!!\nRun \"debianizador\" script as normal user"
    fi
}


function set_working_directory()
{
    echo
    working_dir=${1}
    if [[ -n "${working_dir}" ]] ; then
        if [[ -d "${working_dir}" ]] ; then
            echo -e "Working directory:\n  ${working_dir}"
            cd ${working_dir}
        else
            echo "The directory:"
            echo "${working_dir}"
            echo "does not exist"
            exit 1
        fi
    else
        echo "Warnnig!  $(basename $0) "
        echo "It is mandatory directory with a project and a DEBIAN folder"
        echo "run $(basename $0) -h to show help message"
        exit 1
    fi
}

# if SOURCE exists
function check_sources()
{
    echo
    if [[ -e "${source_dir}${SRC}"  ]] ; then
        echo -e "Source directory:\n  ${source_dir}${SRC}"
    else
        echo -e "Source directory \"${source_dir}${SRC}\" does not exist"
        exit 2
    fi
}


function check_control_file()
{
    echo
    echo -e "Checking control file"
    ## Checking if /debian folder is in the working directory
    if [[ ! -d "./debian" ]] ; then
        echo
        echo "A \"debian\" folder with at least a control file is mandatory"
        echo -ne "Do you want to create \"debian\" folder? (y/N)"
        input_read=''
        read -sn1 input_read
        echo
        if [[ $input_read =~ ^[Yy]$ ]] ; then
            mkdir -p ${working_dir}/debian
        else
            echo "Exiting"
            exit 1
        fi
    fi
    
    ## Checking if control file is into /working_directory/debian folder
    if [[ ! -e ${control_file} ]]  || [[ -z $(cat ${control_file}) ]] ; then
        echo
        echo "Error: You must to create a control file"
        echo -ne "Do you want to create a \"control\" file? (y/N)"
        input_read=''
        read -sn1 input_read
        echo
        ## If control file does not exist or it is emmpty it will be created
        if [[ $input_read =~ ^[Yy]$ ]] ; then
            create_control_file
        else
            echo "sdfsdfs"
            exit 1
        fi
    else  ## If control file exists it will be formated
        echo
        # Formating control file
        (sed -i -e "/^[[:space:]]*$/d" \
        -e "/Description:/,/^$/ {s# *\([[:alnum:]]\+\)# \1#}" \
        -e "s/^ *\(Package:\) *\([[:alnum:]]*\)/\1 \2/" \
        -e "s/^ *\(Version:\) *\([[:alnum:]]*\)/\1 \2/" \
        -e "s/^ *\(Section:\) *\([[:alnum:]]*\)/\1 \2/" \
        -e "s/^ *\(Priority:\) *\([[:alnum:]]*\)/\1 \2/"  \
        -e "s/^ *\(Architecture:\) *\([[:alnum:]]*\)/\1 \2/" \
        -e "s/^ *\(Depends:\) *\([[:alnum:]]*\)/\1 \2/" \
        -e "s/^ *\([[:alnum:]]\+:\) *\([[:alnum:]]*\)/\1 \2/" \
        -e '$a\' ${control_file} \
        && ([[ -s ${control_file}  ]] && echo "Formating \"control\" file")) \
        || (echo "Error formating \"control\" file" && exit 1)
    fi
}


function create_control_file()
{
    touch ${control_file}
    chmod 664 ${control_file}
    package_name=$(basename ${source_dir})
    echo -e "Package: ${package_name}" >> ${control_file}
    echo -e "Version: (i.e. 1.0-1)" >> ${control_file}
    echo -e "Section: (admin|..|devel|games|sound|...)"  >> ${control_file}
    echo -e "Priority: (required|important|standart|optional|extra)" >> ${control_file}
    echo -e "Architecture: (all|i386|amd64|...)" >> ${control_file}
    echo -e "Depends: (foo (>= 1.5.0), bar | baz, qux)" >> ${control_file}
    echo -e "Maintainer: Juan Ramon Castan" >> ${control_file}
    echo -e "Description: (empty line finish)" >> ${control_file}
    echo
    autoedit_control_file
}


function autoedit_control_file()   
{

    local warning
    local section
    local delete_lines
    
    warning=""
    section="Package"
    control_package=""
    section_key=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}:\)\(.*\)|\1|"   ${control_file})
    section_val=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}: *\)\(.*\)|\2|"   ${control_file})
    while : ; do read -r -e -i "${section_val}${warning}" -p "${section_key} >> " control_package ; warning="${warning}!" ; [[ -z $(echo ${control_package} | sed -e "/[^a-zA-Z0-9-]/d") ]] || break ; done
    sed -i -e "s/\(^${section}:\)\( *\)\(.*\)/\1 ${control_package}/" ${control_file}
    
    warning=""
    section="Version"
    control_version=""
    section_key=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}:\)\(.*\)|\1|"   ${control_file})
    section_val=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}: *\)\(.*\)|\2|"   ${control_file})
    while : ; do read -r -e -i "${section_val}${warning}" -p "${section_key} >> " control_version ; warning="${warning}!" ; [[ -z ${control_version} ]] || [[ ! ${control_version} =~ ^[0-9]+\.[0-9]+([.]+[0-9]+)?([-]+.+)?$ ]] || break ; done
    sed -i -e "s/\(^${section}:\)\( *\)\(.*\)/\1 ${control_version}/" ${control_file}
    
    warning=""
    section="Section"
    control_section=""
    section_key=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}:\)\(.*\)|\1|"   ${control_file})
    section_val=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}: *\)\(.*\)|\2|"   ${control_file})
    while : ; do read -r -e -i "${section_val}${warning}" -p "${section_key} >> " control_section ; warning="${warning}!" ; [[ -z ${control_section} ]] || break ; done
    sed -i -e "s/\(^${section}:\)\( *\)\(.*\)/\1 ${control_section}/" ${control_file} 

    warning=""
    section="Priority"
    control_priority=""
    section_key=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}:\)\(.*\)|\1|"   ${control_file})
    section_val=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}: *\)\(.*\)|\2|"   ${control_file})
    while : ; do read -r -e -i "${section_val}${warning}" -p "${section_key} >> " control_priority ; warning="${warning}!" ; [[ -z ${control_priority} ]] || break ;  done
    sed -i -e "s/\(^${section}:\)\( *\)\(.*\)/\1 ${control_priority}/" ${control_file}

    warning=""
    section="Architecture"
    control_architecture=""
    section_key=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}:\)\(.*\)|\1|"   ${control_file})
    section_val=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}: *\)\(.*\)|\2|"   ${control_file})
    while : ; do read -r -e -i "${section_val}${warning}" -p "${section_key} >> " control_architecture ; warning="${warning}!" ; [[ -z ${control_architecture} ]] || break ; done
    sed -i -e "s/\(^${section}:\)\( *\)\(.*\)/\1 ${control_architecture}/" ${control_file}
    
    section="Depends"
    control_depends=""
    section_key=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}:\)\(.*\)|\1|"   ${control_file})
    section_val=$(sed -e "/^${section}:.*/!d" -e "s|\(^${section}: *\)\(.*\)|\2|"   ${control_file})
    read -r -e -i "${section_val}" -p "${section_key} >> " control_depends 
    sed -i -e "s/\(^${section}:\)\( *\)\(.*\)/\1 ${control_depends}/" ${control_file}
    
    warning=""
    section="Description"
    control_description=""
    OLDIFS=${IFS}
    IFS=$'\n'
    for ln in $( sed -ne "/^${section}:/,/^$/p" ${control_file} ) ; do
        if [[ -n $(echo -e "${ln}" | sed -e "/^${section}:.*/!d") ]] ; then
            section_key=$(echo -e "${ln}" | sed -e "/^${section}:.*/!d" -e "s|\(^${section}:\)\(.*\)|\1|" )
            section_val=$(echo -e "${ln}" | sed -e "/^${section}:.*/!d" -e "s|\(^${section}: *\)\(.*\)|\2|" )
        else
            section_key=""
            section_val=$(echo -e "${ln}" |  sed -e "s|\(.*$\)|\1|")
        fi
        section_val=$(echo "${section_val}" | sed -e "s|^ *\(.\+\)|\1|" )


        if [[ -n $delete_lines ]] ; then
                control_description=""
        else
            read -r -e -i "${section_val}" -p "${section_key} >> " control_description 
            control_description=$(echo $control_description | sed -e "s|^ *||g"  )
        fi
        
        if [[ -n "${control_description}" ]] ; then
            sed -i -e "s|\(^${section_key}\)\( *\)\(${section_val}\)|\1 ${control_description}|" ${control_file} 
        else
            sed -i -e "/^.*${section_val}$/d" ${control_file}
            delete_lines="y"
        fi
    done
    if [[ -z $delete_lines ]] ; then
        while : ; do
            read -r -e -p " >> " control_description
            control_description=$(echo ${control_description} | sed -e "s|^ *||"  )
            echo " ${control_description}" >> ${control_file}
            [[ -n "${control_description}" ]] || break
        done
    fi
    
    IFS=$OLDIFS
    echo
    #read_control_file 
    #edit_file ${control_file}
}


function read_control_file()
{
    check_control_file

    # Taking vars from control file
    package=$(sed -e '/^Package/!d' -e 's/Package:[[:space:]]\+\([[:alnum:]]\+\)\.*/\1/' -e "s/[[:space:]]\+//g" ${control_file})
    version=$(sed -e '/^Version/!d' -e 's/Version:[[:space:]]\+\([[:alnum:]]\+.*\)/\1/' -e "s/[[:space:]]\+//g" ${control_file})
    arch=$(sed -e '/^Architecture/!d' -e 's/Architecture:[[:space:]]\+\([[:alnum:]]\+\)/\1/' -e "s/[[:space:]]\+//g" ${control_file})
    buld_dest_dir="${package}_${version}_${arch}"
    build_prefix="/${buld_dest_dir}"
    # Show control file
    echo "********** control file *************"
    cat ${control_file}
    echo "*************************************"

    echo
    echo -e "debian package root directory:"
    echo -e "\t$(basename ${build_prefix})"
    echo

}


function edit_file()
{
    local file="$1"
    echo -ne "Do you want to edit \"$file\" file (a/e/N)?"
    input_read=''
    read -sn1 input_read
    echo
    case $input_read in
        [Aa])
            autoedit_control_file
            read_control_file && edit_file ${file}
            ;;
        [Ee])
            nano "${file}"
            read_control_file && edit_file ${file}
            ;;
        *)
            echo "Skiping edit $file file "
            ;;
    esac
    echo
}


function change_version()
{
    ##################################################################
    ## Change version of files than have the next format inside:
    ## Version: X.X[.X][-something]
    ## With or without # initial comment character
    ## Usually "control" file
    ##         "README" file
    ##         "Makefile"
    ##################################################################
    warning=""
    version=$(sed -e '/^Version/!d' -e 's/Version:[[:space:]]\+\([[:alnum:]]\+.*\)/\1/' -e "s/[[:space:]]\+//g" ${control_file})
    while [[ -z ${version} ]] || [[ ! ${version} =~ ^[0-9]+\.[0-9]+([.]+[0-9]+)?([-]+.+)?$ ]]  ; do
        echo -e "Please, set version${warning}"
        new_version=''
        sed "/^Version:.*/!d" ${control_file}
        read -p ">> " new_version ; warning="${warning}!!"
        sed -i -e "s/\(^Version:\)\( *\)\(.*\)/\1 ${new_version}/" ${control_file}
        version=$(sed -e '/^Version/!d' -e 's/Version:[[:space:]]\+\([[:alnum:]]\+.*\)/\1/' -e "s/[[:space:]]\+//g" ${control_file})
    done

    files_w_version=$(find -L ${source_dir} -type f -not -name "control" \( -exec grep -l -e "^#\{0,1\}[[:space:]]*Version:[[:space:]]\+[[:digit:]]\+.*" {} \; \)  )
    echo -e "Changing the next files to \"Version: ${version}\""
    for file in ${files_w_version} ; do
        echo -ne "From $(sed -e "/Version:[[:space:]]\+[[:digit:]]\+.*/!d" -e "s/^#* *\(Version:.*\)$/\1/" ${file})"
        sed  -i -e "s|\(Version:[[:space:]]\+\)\([[:digit:]]\+.*\)|\1${version}|g" ${file}
        echo -e " to Version: $(sed -e "/Version:[[:space:]]\+[[:digit:]]\+.*/!d" -e "s/^#* *\(Version:.*\)$/\1/" ${file})\n\t${file}"
    done
    echo
}


function prepare()
{
    input_read=${1}
    if [[ ! ${input_read} ]] ; then
        echo -ne "Do you want to PREPARE the files tree of DEB package\nusing \"Makefile\" and \"control\" file (y/N)?"
        read -sn1 input_read
        echo
    fi
    if [[ $input_read =~ ^[Yy]$ ]] ; then
        echo "Preparing files tree to build the package"
        [[ -e .debian/preinst ]] && chmod +x .debian/preinst
        [[ -e .debian/prerm ]] && chmod +x .debian/prerm
        [[ -e .debian/postinst ]] && chmod +x .debian/postinst
        [[ -e .debian/postrm ]] && chmod +x .debian/postrm
        mkdir -p "./${buld_dest_dir}/DEBIAN"
        cp ./debian/* ./${buld_dest_dir}/DEBIAN/
        cd "${source_dir}${SRC}"
        echo "${source_dir}${SRC}"
        echo
        ([[ -e ./Makefile ]] && make  "BUILD=${working_dir}${build_prefix}" install) || exit 1 
    else
        exit 0
    fi
    echo
}


function create()
{
    input_read=${1}
    if [[ ! ${input_read} ]] ; then
        echo -ne "Do you want to BUILD the package ${buld_dest_dir}.deb (y/N)?"
        read -sn1 input_read
        echo
    fi
    
    if [[ $input_read =~ ^[Yy]$ ]] ; then
        echo
        cd "${working_dir}"
        echo "Building the package"
        echo "${buld_dest_dir}"
        fakeroot dpkg-deb --build "${buld_dest_dir}" || exit 1
    else
        echo "Skiping package built"
        exit 0
    fi
    echo
}


function remove()
{
    cd "${working_dir}"
    echo -e "Removing debian root directory, package and symbolic link"
    read_control_file  > /dev/null
    if [[ $(find . -maxdepth 1 -mindepth 1 -type l) =~ "${SRC}" ]] ; then
        rm ./${SRC} && echo "Removing \"${SRC}\" symlink"
    else
        echo "Symbolic link \"${SRC}\" does not exist"
    fi

    ( [[ -d ./${buld_dest_dir} ]] && rm -fR "./${buld_dest_dir}" && echo -e "Removing ${buld_dest_dir} directory" ) || echo "./${buld_dest_dir} does not exist"
    [[ -e ./${buld_dest_dir}.deb ]] && rm "./${buld_dest_dir}.deb" && echo -e "Removing ${buld_dest_dir}.deb package" || echo "./${buld_dest_dir}.deb does not exist"
}


function clean()
{
    clean_target=$(make -npq : 2> /dev/null |     awk -v RS= -F: '$1 ~ /^[^#%.]+$/ { print $1 }' | grep clean)
    if [[ -n "${clean_target}" ]] ; then
        make  "BUILD=${working_dir}${build_prefix}" clean
    else
        echo "No existe el objetivo \"clean\" en este Makefile"
    fi
    
}



function mssg_help()
{
   ( cat <<EOF
Description: $(basename $0) builds a .deb package from sources.

Usage:
  $(basename $0) [-h] [-y] [-c -r -d] <SOURCE_DIRECTORY>  [<working_dir>]

<SOURCE_DIRECTORY>
        Containing at least a "source" directory with its make files

<WORKING_DIRECTORY>
        The directory where the DEB package will be created.
        If a "debian" directory, with its "control" file does not exist
        the script will create.
        
        If a <WORKING_DIRECTORY>  is not passsed as argument
        it will use the current working directory.

Options:
  -h  Shows this message.
  -y  It assume YES for all questions: prepare, build and install.
  -c  Execute clean from sources Makefile .
  -r  Removes the tree root directories of DEB package.

A source directory is mandatory and a "Makefile" that
recreates the files tree in the package root directory.

A "debian" directory is necessary, with a "control" file
and optionally postinst, postrm, etc files, which content
will be copied to "DEBIAN" folder in the package root
directory named "Package_Version_Architecture" obtained
from "control" file.

The deb package will be named as package root directory 
with .deb extension:
  Package_Version_Architecture.deb

EOF
) | less
}

OPTIONS=$(getopt  -o "hycr" -n '$0' -- "$@")

if [ $? != 0 ] ; then
  exit 1 ;
fi

eval set -- "$OPTIONS"

while true ; do 
    case $1 in 
            -y)
                GLOBAL_INPUT='y'
                shift
                ;;
            -h)
                mssg_help
                shift
                exit 0
                ;;
            -r)
                REMOVE="Y"
                EXIT="exit 0"
                shift
                ;;
            -c)
                CLEAN="Y"
                EXIT="exit 0"
                shift
                ;;
            --)
                check_user ; shift
                
                if [[ -n $1 ]] ; then
                    source_dir=$(realpath ${1})
                    shift
                fi
                
                check_sources

                if [[ -n $1 ]] ; then
                    WD=$(realpath ${1})
                    shift
                else
                    WD=${PWD}
                    echo -e "Warning!"
                    echo -e "Argument <WORKING_DIRECTORY> is not passed"
                    echo -e "It will use current directory"
                    echo -e "\"${WD}\""
                    echo -e "as project root directory"
                fi
                
                set_working_directory ${WD}
                [[ -n "${REMOVE}" ]] && remove
                [[ -n "${CLEAN}" ]] && clean
                ${EXIT}
                read_control_file && edit_file ${control_file}
                change_version
                prepare 
                create 
                
                echo
                break
                ;;
            *)
                shift
                exit 1
                ;;
    esac
done

exit 0

